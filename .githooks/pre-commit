#!/bin/bash

# Pre-commit hook for TDD enforcement
# Fast checks only (~10 seconds)

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print status
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“ $2${NC}"
    else
        echo -e "${RED}âœ— $2${NC}"
        exit 1
    fi
}

# 1. Check for compilation errors
echo ""
echo "ðŸ“¦ Checking compilation..."
./gradlew classes testClasses --quiet 2>/dev/null
print_status $? "Compilation successful"

# 2. Check for TODO/FIXME in staged files (warning only)
echo ""
echo "ðŸ“ Checking for TODO/FIXME comments..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|java)$' || true)
if [ -n "$STAGED_FILES" ]; then
    TODO_COUNT=$(echo "$STAGED_FILES" | xargs grep -c -E '(TODO|FIXME)' 2>/dev/null | grep -v ':0$' | wc -l || true)
    if [ "$TODO_COUNT" -gt 0 ]; then
        echo -e "${YELLOW}âš  Found TODO/FIXME comments in staged files (not blocking)${NC}"
    else
        echo -e "${GREEN}âœ“ No TODO/FIXME found${NC}"
    fi
fi

# 3. Check for .block() usage in production code (not test)
echo ""
echo "ðŸš« Checking for .block() in production code..."
PROD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/main/.*\.(kt|java)$' || true)
if [ -n "$PROD_FILES" ]; then
    BLOCK_USAGE=$(echo "$PROD_FILES" | xargs grep -l '\.block()' 2>/dev/null || true)
    if [ -n "$BLOCK_USAGE" ]; then
        echo -e "${RED}âœ— Found .block() in production code:${NC}"
        echo "$BLOCK_USAGE"
        exit 1
    fi
fi
echo -e "${GREEN}âœ“ No .block() in production code${NC}"

# 4. Check for sensitive files
echo ""
echo "ðŸ”’ Checking for sensitive files..."
SENSITIVE_PATTERNS=".env credentials secret password.* *.pem *.key"
for pattern in $SENSITIVE_PATTERNS; do
    SENSITIVE_FILES=$(git diff --cached --name-only | grep -i "$pattern" || true)
    if [ -n "$SENSITIVE_FILES" ]; then
        echo -e "${RED}âœ— Potentially sensitive file detected: $SENSITIVE_FILES${NC}"
        exit 1
    fi
done
echo -e "${GREEN}âœ“ No sensitive files detected${NC}"

echo ""
echo -e "${GREEN}âœ… Pre-commit checks passed!${NC}"
echo ""
